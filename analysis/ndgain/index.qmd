---
title: Untitled
subtitle: A slightly longer title
format:
  360-analysis-html: default
author: James Goldie
date: last-modified
code-fold: true
---

```{r}
#| label: setup
library(tidyverse)
library(here)
```

## Introduction

```{r}
#| label: download-ndgain
download_if_not_present <- function(url, dest_zip, dest_dir,
  temp_timeout = 3600) {
  if (!file.exists(dest_zip)) {
    message(paste0("Downloading data: ", basename(url), "..."))
    old_timeout <- options("timeout")
    options(timeout = temp_timeout)
    download.file(url, dest_zip)
    unzip(dest_zip, exdir = dest_dir)
    options(timeout = old_timeout)
  } else {
    message("Skipping download of ", basename(url))
  }
}

# ndgain
ndgain_dir <- here("data", "raw-ndgain")
download_if_not_present(
  "https://gain.nd.edu/assets/521644/nd_gain_country_index_2023.zip",
  here("data", "ndgain.zip"),
  ndgain_dir)
```

These CSV files appear to all have exactly the same structure, so let's just load them all into one data frame:
```{r}
#| label: load-files

list.files(ndgain_dir, pattern = glob2rx("*.csv"),
  recursive = TRUE, full.names = TRUE) |>
  tibble(
    path = _,
    base_path = path |>
      str_remove(here(ndgain_dir, "resources")) |>
      str_replace(".csv", ""),
    data = map(path, read_csv)) ->
nested_data

nested_data |>
  select(-path) |>
  unnest(data) |>
  mutate(base_path = str_sub(base_path, 2)) |>
  separate(base_path,
    into = c("category", "measure", "indicator"), # indicators has third levels!
    sep = "/",
    fill = "right") ->
all_data
```